<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
   "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd"  [ ]>

<chapter id="jpa-relation-fkey">
    <title>Foreign Keys</title>
        
    <section id="jpa-relation-fkey-pkjoin">
        <title>Primary Key Join</title>
        <itemizedlist spacing="compact">
            <listitem><para>Special case of <link linkend="jpa-relation-o2o">one-to-one mapping</link></para></listitem>
            <listitem><para>Uses primary key as the foreign key</para></listitem>
            <listitem><para>No additional column for foreign key</para></listitem>
            <listitem><para>Primary keys must match</para></listitem>
        </itemizedlist>
        
        <figure>
            <title>Primary Key Join</title>
            <graphic scale="110" fileref="images/jpa-relation-fkey-pkjoin.png"/>
        </figure>
        
        <figure>
            <title>Primary Key Join Example Database Schema</title>
<programlisting language=""><![CDATA[
    create table ORMREL_BORROWER (
+-----  BORROWER_ID bigint not null,
|       endDate date,
|       startDate date,
|       primary key (BORROWER_ID)
|   )
|   create table ORMREL_PERSON (
+---->  PERSON_ID bigint generated by default as identity,
        firstName varchar(255),
        lastName varchar(255),
        phone varchar(255),
        PERSON_PHOTO bigint,
        primary key (PERSON_ID)
    )
    alter table ORMREL_BORROWER 
        add constraint FKA0973E32F113D9BA 
        foreign key (BORROWER_ID) 
        references ORMREL_PERSON
]]></programlisting>                        
        </figure>

        <figure>
            <title>Primary Key Join Example Java Mapping</title>
<programlisting language="java"><![CDATA[
    @Entity @Table(name="ORMREL_BORROWER")
    public class Borrower  {
        @Id @Column(name="BORROWER_ID")
+-----  private long id;
|       
|       @OneToOne(fetch=FetchType.LAZY, optional=false, 
|               cascade={CascadeType.PERSIST, 
|                        CascadeType.REFRESH,
|                        CascadeType.MERGE})
|       @PrimaryKeyJoinColumn  //the two tables will be joined by PKs
+-----  private Person identity;
|       
|   @Entity
|   @Table(name="ORMREL_PERSON")
|   public class Person  {
|       @Id @GeneratedValue @Column(name="PERSON_ID")
+---->  private long id;]]></programlisting>

<programlisting language="java"><![CDATA[    public Borrower(Person identity) {
        this.id = identity.getId();
        this.identity = identity;
    }]]></programlisting>                        
        </figure>

    <note>
        <para>In this case, the primary key is used as the foreign key and must be set.
            To use the foreign key as the primary key -- use @MapsId</para>
<programlisting language=""><![CDATA[    //@PrimaryKeyJoinColumn  //the two tables will be joined by PKs
    @MapsId
    private Person identity;
    public Borrower(Person identity) {
        this.identity = identity;
    }]]></programlisting>                        
    </note>                        


        <figure>
            <title>Primary Key Join Example Usage</title>
<programlisting language="java"><![CDATA[
//create the person we'll use in the relationship
ejava.examples.orm.rel.annotated.Person person = new Person();
...
//create the Borrower, who requires a Person for its identity
ejava.examples.orm.rel.annotated.Borrower borrower = new Borrower(person);
borrower.setStartDate(new Date());

//persist the borrower, creating the relationship to person
em.persist(borrower);
log.info("created borrower:" + borrower);
assertEquals(person.getId(), borrower.getId()); //ctor copies PK         
]]></programlisting>                        
        </figure>
        
        
        <section id="jpa-relation-fkey-pkjoin-annotation">
           <title>@PrimaryKeyJoinAnnotation</title>
           <para>Signals primary key column used as foreign key -- no separate foreign key column</para>
            <variablelist spacing="compact">
                <varlistentry>
                    <term><filename>name (default=primary key column of this entity)</filename></term>
                    <listitem><para>Names column in this entity's table this property maps to when using composite keys</para></listitem>
                </varlistentry>
                <varlistentry>
                    <term><filename>referencedColumnName (default=primary key column of joined entity)</filename></term>
                    <listitem><para>Names column in joined entity table this property maps to when using composite keys</para></listitem>
                </varlistentry>
                <varlistentry>
                    <term><filename>columnDefinition</filename></term>
                    <listitem><para>Custom DDL definition for column when generating database schema</para></listitem>
                </varlistentry>
            </variablelist>
           
        </section>    

        
    </section>

    <section id="jpa-relation-fkey-pkreuse">
        <title>Using Composite Primary Key Property as Foreign Key</title>
        <para/>

        <section id="jpa-relation-fkey-pkreuse-idclass">
            <title>Using @IdClass Composite Primary Key Property as Foreign Key</title>
            <para/>
        </section>
        <section id="jpa-relation-fkey-pkreuse-embeddedid">
            <title>Using @EmbeddedId Composite Primary Key Property as Foreign Key</title>
            <para/>
        </section>
    </section>

    <section id="jpa-relation-fkey-mapsid">
        <title>Using Foreign Key in Composite Primary Key (@MapsId)</title>
        <para/>
        <section id="jpa-relation-fkey-mapsid-idclass">
            <title>Using Foreign Key in @IdClass Composite Primary Key (@MapsId)</title>
            <para/>
        </section>
        <section id="jpa-relation-fkey-mapsid-embeddedid">
            <title>Using Foreign Key in @EmbeddedId Composite Primary Key (@MapsId)</title>
            <para/>
        </section>
    </section>

    <section id="jpa-relation-fkey-jointable">
        <title>Join Tables</title>
        
        <figure>
            <title>Join/Link Table</title>
            <graphic scalefit="1" fileref="images/jpa-relation-one-to-many-uni-jointable.png"/>
        </figure>
        <itemizedlist spacing="compact">
            <listitem><para>Separate table created to hold foreign keys</para></listitem>
            <listitem><para>Can be used for all relationship enumatations and directions</para></listitem>
        </itemizedlist>
        
        <figure>
            <title>Join/Link Table Database Table Schema</title>
<programlisting language="java"><![CDATA[    create table ORMREL_INVENTORY (
/---->  id bigint generated by default as identity,
|       name varchar(255),
|       primary key (id)
|   )
|   create table ORMREL_INVENTORY_MEDIA (
`-----  ORMREL_INVENTORY_id bigint not null,
/-----  media_MEDIA_ID bigint not null
|   )
|   create table ORMREL_MEDIA (
`---->  MEDIA_ID bigint generated by default as identity,
        title varchar(255),
        primary key (MEDIA_ID)
    )]]></programlisting>
        </figure>
        <itemizedlist spacing="compact">
            <listitem><para>Join table name either derived from associated tables or explicitly named</para></listitem>
            <listitem><para>Join table columns either derived from referenced table column or explicitly named</para></listitem>
        </itemizedlist>
                                
        <figure>
            <title>Join/Link Table Database Constraint Schema</title>
<programlisting language=""><![CDATA[    alter table ORMREL_INVENTORY_MEDIA 
        add constraint UK_F6FA5C31B7DAA951 unique (media_MEDIA_ID)
    alter table ORMREL_INVENTORY_MEDIA 
        add constraint FKF6FA5C31A70D4E48 
        foreign key (media_MEDIA_ID) 
        references ORMREL_MEDIA
    alter table ORMREL_INVENTORY_MEDIA 
        add constraint FKF6FA5C317DD5E49D 
        foreign key (ORMREL_INVENTORY_id) 
        references ORMREL_INVENTORY]]></programlisting>                        
        </figure>
        <itemizedlist spacing="compact">
            <listitem><para>Unique constraint enforces the (1)-to-Many aspect of relationship</para></listitem>
        </itemizedlist>

        <figure>
            <title>Join/Link Table Database Java Mapping</title>
<programlisting language="java"><![CDATA[
    @Entity @Table(name="ORMREL_INVENTORY")
    public class Inventory {
        @Id @GeneratedValue
        private long id;
        private String name;
    
        @OneToMany(cascade={CascadeType.ALL})
        @JoinTable(name="ORMREL_INVENTORY_MEDIA")
/-----  private Collection<Media> media = new ArrayList<Media>();
|   
|   @Entity @Table(name="ORMREL_MEDIA")
|   public class Media  {    
|       @Id @GeneratedValue @Column(name="MEDIA_ID")
`---->  private long id;
]]></programlisting>                        
        </figure>

        <section id="jpa-relation-fkey-jointable-annotation">
           <title></title>
            <variablelist spacing="compact">
                <varlistentry>
                    <term><filename>name</filename></term>
                    <listitem><para>Database table name for join table</para></listitem>
                </varlistentry>
                <varlistentry>
                    <term><filename>catalog</filename></term>
                    <listitem><para>Database catalog for join table</para></listitem>
                </varlistentry>
                <varlistentry>
                    <term><filename>schema</filename></term>
                    <listitem><para>Database schema for join table</para></listitem>
                </varlistentry>
                <varlistentry>
                    <term><filename>joinColumns</filename></term>
                    <listitem><para>List of @JoinColumn definitions from join table back to owning entity class table</para></listitem>
                </varlistentry>
                <varlistentry>
                    <term><filename>inverseJoinColumns</filename></term>
                    <listitem><para>List of @JoinColumn definitions from join table to inverse entity class table</para></listitem>
                </varlistentry>
                <varlistentry>
                    <term><filename>uniqueConstraints</filename></term>
                    <listitem><para>Uniqueness constraints to be added to join table</para></listitem>
                </varlistentry>
            </variablelist>
        </section>    


    </section>

    <section id="jpa-relation-fkey-">
        <title></title>
        <para/>
    </section>
</chapter>
  
